{
  "id": "6613d333fe0da4edf9b4accb",
  "name": "Refactoring SQL Queries: part 2 (Pagination Disaster)",
  "slug": "refactoring-sql-queries-part-2-pagination-disaster",
  "category": "reference",
  "publishedAt": "2024-04-08T11:23:23.584Z",
  "approvedAt": "2024-05-21T21:29:23.905Z",
  "languages": [
    "sql"
  ],
  "url": "https://www.codewars.com/kata/6613d333fe0da4edf9b4accb",
  "rank": {
    "id": -6,
    "name": "6 kyu",
    "color": "yellow"
  },
  "createdAt": "2024-04-08T11:21:23.537Z",
  "createdBy": {
    "username": "bornForThis",
    "url": "https://www.codewars.com/users/bornForThis"
  },
  "approvedBy": {
    "username": "dfhwze",
    "url": "https://www.codewars.com/users/dfhwze"
  },
  "description": "A financial analysis platform is facing an issue with its current database query logic. The platform, which provides insights into various financial deals and their associated financial tranches, was developed to help clients analyze deal performance across different currencies. Initially, a developer wrote an SQL query to aggregate transaction amounts by both deal and currency. This query worked well for the primary use case of showing aggregated data per deal per currency.\n\nHowever, a recent bug report from a major client highlighted a critical issue: when viewing the deal summaries with pagination, the currency data for a single deal could span multiple pages. This issue arose because the pagination was breaking up the data for a single deal across different pages due to the grouping by both deal and currency. As a result, clients couldn't view a complete summary of a deal on a single page, leading to confusion and inefficiency.\n\nThe client's requirement is to have each page display complete information for each deal, irrespective of the number of currencies involved. Therefore, the task is to refactor the SQL query to ensure that pagination is based solely on deals, not on the currency breakdowns within those deals.\n\nThe original query written by the previous developer is as follows:\n\n```sql\nselect deals.deal_id, deals.deal_name, tranches.currency, sum(tranches.amount) as total_amount\nfrom deals\njoin tranches using (deal_id)\ngroup by deals.deal_id, tranches.currency\norder by deals.deal_id desc, tranches.currency;\n```\n\nYour task is to refactor this query to meet the client's requirements. The refactored query should group the data only by deal, not by currency, to allow for proper pagination. Each deal should present an aggregated summary of the tranches across different currencies. We need to aggregate currency details into a JSON array, which can then be handled in the programming layer of the platform.\n\nExpected Outcome:\n\n1) The refactored query should return each deal's ID and name, along with a JSON array of currency details (each currency and its total amount).\n2) Ensure that the currency details are consistently ordered (by currency in ascending order).\n3) The pagination should be based on deals, ensuring that each deal's information, regardless of how many currencies are involved, is displayed completely on one page.\n\nWe have `deals` table:\n\n* `deal_id` (integer, primary key): Unique identifier for each deal.\n* `deal_name` (string): Name of the deal.\n\nand `tranches` table:\n\n* `id` (integer, primary key): Unique identifier for each tranche record.\n* `deal_id` (integer, foreign key): references `deal_id` in the `deals` table. Indicates which deal this tranche belongs to.\n* `currency` (string): Currency of the tranche (e.g., USD, EUR).\n* `amount` (float): Amount of money in the tranche in its specified currency.\n\n\nThe resultant set should include:\n\n1) `deal_id` (integer): The unique identifier for each deal.\n2) `deal_name` (string): The name of the deal.\n3) `currency_details` (JSON Array): A JSON array ordered by currency in ascending order where each element is a JSON object containing:\n    1) `currency` (string): The currency of the tranches.\n    2) `total_amount` (float): Total amount aggregated for this currency.\n    \nResult should be ordered by `deal_id` in descending order.\n\nFor this sample data: \n\n```\ndeals: \n\n| deal_id | deal_name |\n+---------+-----------+\n|       1 | Deal A    |\n|       2 | Deal B    |\n```\n\n\n```\ntranches: \n\n| id | deal_id | currency | amount |\n+----+---------+----------+--------+\n|  1 |       1 | USD      | 1000.0 |\n|  2 |       1 | EUR      |  800.0 |\n|  3 |       1 | EUR      |  400.0 |\n|  4 |       2 | USD      |  500.0 |\n|  5 |       2 | GBP      |  600.0 |\n```\n\nthe desired output is the following: \n\n<table><!----><tr><th>deal_id</th><th>deal_name</th><th>currency_details</th></tr><tr><td>2</td><td>Deal B</td><td>[{\"currency\" : \"GBP\", \"total_amount\" : 600}, {\"currency\" : \"USD\", \"total_amount\" : 500}]</td></tr><tr><td>1</td><td>Deal A</td><td>[{\"currency\" : \"EUR\", \"total_amount\" : 1200}, {\"currency\" : \"USD\", \"total_amount\" : 1000}]</td></tr></table>\n\nGLHF!\n\n\n\n\n\n\n",
  "totalAttempts": 935,
  "totalCompleted": 138,
  "totalStars": 10,
  "voteScore": 32,
  "tags": [
    "SQL",
    "Databases",
    "Refactoring"
  ],
  "contributorsWanted": true,
  "unresolved": {
    "issues": 0,
    "suggestions": 0
  }
}